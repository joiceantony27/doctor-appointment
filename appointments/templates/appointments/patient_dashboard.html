{% extends 'appointments/base.html' %}
{% load static %}
{% load appointment_tags %}
{% load appointment_filters %}

{% block title %}Patient Dashboard - MedApp{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'appointments/css/patient_dashboard.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<!-- Razorpay script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<style>
    .doctor-note-card {
        border-radius: 10px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        overflow: hidden;
        transition: transform 0.2s;
    }
    
    .doctor-note-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .doctor-note-card.new-reply {
        border-left: 4px solid #0d6efd;
    }
    
    .note-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .patient-message {
        border-left: 3px solid #6c757d;
        padding-left: 15px;
    }
    
    .doctor-reply {
        border-left: 3px solid #0d6efd;
        padding-left: 15px;
    }
    
    .reply-content {
        background-color: #f0f7ff !important;
    }
    
    .waiting-reply {
        font-style: italic;
    }
    
    /* Appointment row highlight styles */
    .highlight-new {
        animation: highlight-pulse 2s ease-in-out infinite;
        background-color: rgba(40, 167, 69, 0.1);
    }
    
    @keyframes highlight-pulse {
        0% { background-color: rgba(40, 167, 69, 0.4); }
        50% { background-color: rgba(40, 167, 69, 0.1); }
        100% { background-color: rgba(40, 167, 69, 0.4); }
    }
    
    .appointment-row {
        transition: background-color 0.3s ease;
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Fix for footer overlapping buttons */
    .appointments-table {
        position: relative;
        z-index: 10;
        margin-bottom: 60px;
    }
    
    .table-responsive {
        overflow: visible;
    }
    
    .modal {
        z-index: 1050;
    }
    
    .btn {
        position: relative;
        z-index: 5;
    }
    
    footer {
        position: relative;
        z-index: 1;
    }
    
    /* Ensure appointment action buttons are clickable */
    .appointment-row td:last-child {
        position: relative;
        z-index: 5;
    }
    
    /* Add more space at bottom of page */
    .patient-dashboard {
        padding-bottom: 80px;
    }
    
    /* Additional modal fixes */
    .modal-dialog {
        z-index: 1055 !important;
    }
    
    .modal-backdrop {
        z-index: 1040 !important;
    }
    
    /* Fix for button clickability */
    .btn-group {
        position: relative;
        z-index: 10;
    }
    
    /* Ensure table cells don't get cut off */
    .table td, .table th {
        position: relative;
        z-index: 2;
    }
    
    /* Prevent any page elements from overlapping modals */
    body.modal-open {
        overflow: hidden;
    }
    
    /* Ensure action buttons are always on top */
    .btn-success, .btn-primary, .btn-danger, .btn-outline-primary {
        position: relative;
        z-index: 1000 !important;
    }
    
    /* Payment status badges */
    .payment-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }
    
    .payment-badge.pending {
        background-color: #ffc107;
        color: #212529;
    }
    
    .payment-badge.paid {
        background-color: #28a745;
        color: #fff;
    }
    
    /* Invoice button styling */
    .btn-invoice {
        background-color: #fff;
        color: #0d6efd;
        border: 1px solid #0d6efd;
        transition: all 0.2s;
    }
    
    .btn-invoice:hover {
        background-color: #f8f9fa;
    }
    
    /* Payment processing overlay */
    .payment-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .payment-overlay-content {
        background-color: white;
        padding: 2rem;
        border-radius: 8px;
        text-align: center;
        max-width: 400px;
    }
    
    /* Payment success toast */
    .payment-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #28a745;
        color: white;
        padding: 15px 25px;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        z-index: 1060;
        display: flex;
        align-items: center;
        animation: slideIn 0.5s, fadeOut 0.5s 4.5s;
        animation-fill-mode: forwards;
    }
    
    .payment-toast i {
        margin-right: 10px;
        font-size: 1.2rem;
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    
    /* Doctor avatar and info styles */
    .doctor-avatar img {
        object-fit: cover;
        border: 2px solid #e9ecef;
    }
    
    .doctor-avatar img:hover {
        border-color: #0d6efd;
    }
    
    .fw-medium {
        font-weight: 500;
    }
    
    td .small.text-muted {
        font-size: 0.75rem;
        line-height: 1.2;
    }
</style>
{% endblock %}

{% block content %}
<div class="patient-dashboard">
    <div class="container py-4">
        <!-- Header Section -->
        <!-- Global CSRF token for JavaScript operations -->
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

        <div class="container patient-dashboard mb-5 pb-5">
            <!-- Django messages -->
            {% if messages %}
            <div class="messages mt-3">
                {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% elif message.tags == 'success' %}success{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                    <i class="fas fa-{% if message.tags == 'error' %}exclamation-circle{% elif message.tags == 'success' %}check-circle{% else %}info-circle{% endif %} me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Success message for appointment booking -->
            <div id="appointmentSuccessMessage" class="alert alert-success alert-dismissible fade show mt-3" role="alert" style="display: none;">
                <i class="fas fa-check-circle me-2"></i>
                <span id="appointmentSuccessText">Appointment booked successfully!</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <div class="row g-4">
                <!-- Profile Summary -->
                <div class="col-md-4">
                    <div class="profile-card p-4 text-center">
                        {% if user.profile_picture %}
                            <img src="{{ user.profile_picture.url }}" class="profile-image mb-3" alt="{{ user.get_full_name }}">
                        {% else %}
                            <img src="https://via.placeholder.com/150x150" class="profile-image mb-3" alt="Profile placeholder">
                        {% endif %}
                        <h4 class="mb-2">{{ user.get_full_name }}</h4>
                        <p class="text-muted mb-2">{{ user.email }}</p>
                        <p class="mb-0">
                            <i class="fas fa-phone me-2"></i>{{ user.phone_number }}
                        </p>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="col-md-8">
                    <div class="quick-actions">
                        <div class="action-card p-4">
                            <h6 class="card-title mb-2">Find Doctors</h6>
                            <p class="card-text text-muted mb-3">Search and book appointments with doctors</p>
                            <a href="{% url 'appointments:doctor_list' %}" class="btn btn-primary action-btn">Find Doctors</a>
                        </div>

                        <div class="action-card p-4">
                            <h6 class="card-title mb-2">Profile Settings</h6>
                            <p class="card-text text-muted mb-3">Update your personal information</p>
                            <a href="{% url 'appointments:edit_patient_profile' %}" class="btn btn-primary action-btn">Edit Profile</a>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Navigation -->
                <div class="col-12">
                    <div class="dashboard-nav">
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" href="#appointments" data-bs-toggle="tab">Appointments</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#profile" data-bs-toggle="tab"></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#doctor-notes" data-bs-toggle="tab">Doctor Notes</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'appointments:notes_list' %}"></a>
                            </li>
                        </ul>
                    </div>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="appointments">
                            {% include 'appointments/appointments_list.html' %}
                        </div>
                        <div class="tab-pane fade" id="profile">
                            {% include 'appointments/patient_profile.html' %}
                        </div>
                        <div class="tab-pane fade" id="doctor-notes">
                            <!-- Doctor Notes Section -->
                            <div class="doctor-notes-section p-4">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 class="mb-0">Doctor Communication</h5>
                                    <div>
                                        <a href="{% url 'appointments:create_note' %}" class="btn btn-outline-primary btn-sm me-2">
                                            <i class="fas fa-sticky-note"></i> Create Note
                                        </a>
                                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newDoctorNoteModal">
                                            <i class="fas fa-plus"></i> New Message
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Debug info -->
                                <div class="debug-info border p-3 mb-3 small">
                                    <strong>Debug Information:</strong>
                                    <p>Total doctor messages: {{ doctor_notes|length }}</p>
                                    {% if doctor_notes %}
                                        <ul>
                                        {% for note in doctor_notes %}
                                            <li>
                                                Message to Dr. {{ note.doctor.user.get_full_name }}: {{ note.message|truncatechars:30 }}
                                                <br>
                                                {% if note.reply %}
                                                    <span class="text-success">Has reply: "{{ note.reply|truncatechars:30 }}"</span>
                                                {% else %}
                                                    <span class="text-secondary">No reply yet</span>
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                        </ul>
                                    {% endif %}
                                    <details class="mt-2">
                                        <summary>View message IDs</summary>
                                        <ul class="mt-2">
                                        {% for note in doctor_notes %}
                                            <li>Message #{{ note.id }} - {% if note.reply %}has reply{% else %}no reply{% endif %}</li>
                                        {% endfor %}
                                        </ul>
                                    </details>
                                </div>
                                
                                <!-- Notes Type Selector -->
                                <ul class="nav nav-pills mb-4">
                                    <li class="nav-item">
                                        <button class="nav-link active" id="communication-tab" data-bs-toggle="pill" data-bs-target="#communication-content" type="button">Direct Communication</button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" id="my-notes-tab" data-bs-toggle="pill" data-bs-target="#my-notes-content" type="button">My Personal Notes</button>
                                    </li>
                                </ul>
                                
                                <div class="tab-content">
                                    <!-- Direct Communication with Doctors -->
                                    <div class="tab-pane fade show active" id="communication-content">
                                        {% if doctor_notes %}
                                            <!-- Filter tabs -->
                                            <ul class="nav nav-pills mb-3">
                                                <li class="nav-item">
                                                    <button class="nav-link active" id="all-notes-tab" data-filter="all">All Messages</button>
                                                </li>
                                                <li class="nav-item">
                                                    <button class="nav-link" id="replied-notes-tab" data-filter="replied">With Replies</button>
                                                </li>
                                                <li class="nav-item">
                                                    <button class="nav-link" id="pending-notes-tab" data-filter="pending">Waiting Reply</button>
                                                </li>
                                            </ul>
                                            
                                            <div class="doctor-notes-list">
                                                {% for note in doctor_notes %}
                                                    <div class="doctor-note-card mb-4 note-item {% if note.reply %}has-reply{% else %}pending-reply{% endif %} {% if not note.is_read_by_patient and note.reply %}new-reply{% endif %}">
                                                        <div class="note-header d-flex justify-content-between align-items-center p-3">
                                                            <div>
                                                                <h6 class="mb-0">To: Dr. {{ note.doctor.user.get_full_name }}</h6>
                                                                <small class="text-muted">{{ note.created_at|date:"F d, Y" }} at {{ note.created_at|date:"g:i A" }}</small>
                                                            </div>
                                                            <div>
                                                                {% if not note.is_read_by_patient and note.reply %}
                                                                    <span class="badge bg-primary">New Reply</span>
                                                                {% endif %}
                                                                {% if note.reply %}
                                                                    <span class="badge bg-success ms-1">Replied</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary ms-1">Waiting</span>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        <div class="note-body p-3">
                                                            <div class="patient-message mb-3">
                                                                <div class="d-flex align-items-center mb-2">
                                                                    <div class="message-sender-info">
                                                                        <small class="text-muted">My message:</small>
                                                                    </div>
                                                                </div>
                                                                <div class="message-content">
                                                                    <p class="mb-0">{{ note.message }}</p>
                                                                </div>
                                                            </div>
                                                            {% if note.reply %}
                                                                <div class="doctor-reply">
                                                                    <div class="reply-header d-flex align-items-center mb-2">
                                                                        <img src="{% if note.doctor.profile_picture %}{{ note.doctor.profile_picture.url }}{% else %}{% static 'images/default-doctor.png' %}{% endif %}" class="rounded-circle me-2" width="30" height="30">
                                                                        <strong>Dr. {{ note.doctor.user.get_full_name }}</strong>
                                                                        <small class="text-muted ms-2">{{ note.replied_at|date:"F d, Y" }} at {{ note.replied_at|date:"g:i A" }}</small>
                                                                    </div>
                                                                    <div class="reply-content bg-light p-3 rounded">
                                                                        {{ note.reply }}
                                                                    </div>
                                                                </div>
                                                            {% else %}
                                                                <div class="waiting-reply text-muted">
                                                                    <i class="fas fa-clock me-2"></i> Waiting for reply
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        {% if note.reply %}
                                                        <div class="note-footer p-3 border-top">
                                                            <button type="button" class="btn btn-sm btn-outline-primary reply-again-btn" data-bs-toggle="modal" data-bs-target="#newDoctorNoteModal" data-doctor-id="{{ note.doctor.id }}">
                                                                <i class="fas fa-reply"></i> Reply Again
                                                            </button>
                                                            {% if not note.is_read_by_patient %}
                                                                <a href="{% url 'appointments:mark_note_as_read' note.id %}" class="btn btn-sm btn-outline-secondary float-end">
                                                                    <i class="fas fa-check"></i> Mark as Read
                                                                </a>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <div class="text-center py-5">
                                                <i class="fas fa-comment-medical text-muted" style="font-size: 3rem;"></i>
                                                <p class="mt-3 mb-0">You don't have any messages with doctors yet.</p>
                                                <p class="text-muted">Click the "New Message" button to start a conversation.</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Personal Notes -->
                                    <div class="tab-pane fade" id="my-notes-content">
                                        {% if patient_notes %}
                                            <!-- Filter tabs for personal notes -->
                                            <ul class="nav nav-pills mb-3">
                                                <li class="nav-item">
                                                    <button class="nav-link active" id="all-personal-notes-tab" data-filter-personal="all">All Notes</button>
                                                </li>
                                                <li class="nav-item">
                                                    <button class="nav-link" id="shared-notes-tab" data-filter-personal="shared">Shared with Doctor</button>
                                                </li>
                                                <li class="nav-item">
                                                    <button class="nav-link" id="private-notes-tab" data-filter-personal="private">Private Notes</button>
                                                </li>
                                            </ul>
                                            
                                            <div class="patient-notes-list">
                                                {% for note in patient_notes %}
                                                    <div class="doctor-note-card mb-4 personal-note-item {% if note.share_with_doctor %}shared-note{% else %}private-note{% endif %}">
                                                        <div class="note-header d-flex justify-content-between align-items-center p-3">
                                                            <div>
                                                                <h6 class="mb-0">{{ note.title }}</h6>
                                                                <small class="text-muted">{{ note.created_at|date:"F d, Y" }} at {{ note.created_at|date:"g:i A" }}</small>
                                                            </div>
                                                            <div>
                                                                <span class="badge {% if note.share_with_doctor %}bg-info{% else %}bg-secondary{% endif %} ms-1">
                                                                    {% if note.share_with_doctor %}Shared{% else %}Private{% endif %}
                                                                </span>
                                                                <span class="badge bg-primary ms-1">{{ note.get_category_display }}</span>
                                                            </div>
                                                        </div>
                                                        <div class="note-body p-3">
                                                            <div class="note-content">
                                                                <p>{{ note.content }}</p>
                                                            </div>
                                                        </div>
                                                        <div class="note-footer p-3 border-top">
                                                            <a href="{% url 'appointments:edit_note' note.id %}" class="btn btn-sm btn-outline-primary">
                                                                <i class="fas fa-edit"></i> Edit
                                                            </a>
                                                            <a href="{% url 'appointments:delete_note' note.id %}" class="btn btn-sm btn-outline-danger ms-2">
                                                                <i class="fas fa-trash"></i> Delete
                                                            </a>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <div class="text-center py-5">
                                                <i class="fas fa-sticky-note text-muted" style="font-size: 3rem;"></i>
                                                <p class="mt-3 mb-0">You don't have any personal notes yet.</p>
                                                <p class="text-muted">Click the "Create Note" button to write your first note.</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Appointments -->
                <div class="col-12">
                    <div class="appointments-table p-4 mb-5 position-relative" style="z-index: 100;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="mb-0">My Appointments <span class="text-muted fs-6">({{ appointments|length }} of {{ all_appointments_count }})</span></h5>
                        </div>
                        {% if appointments %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Doctor</th>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                            <th>Payment</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for appointment in appointments %}
                                            <tr class="fade-in appointment-row {% if new_appointment_id and appointment.id|stringformat:'s' == new_appointment_id %}highlight-new{% endif %}" data-appointment-id="{{ appointment.id }}">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="doctor-avatar me-2">
                                                            {% if appointment.doctor.profile_picture %}
                                                                <img src="{{ appointment.doctor.profile_picture.url }}" class="rounded-circle" width="40" height="40" alt="Dr. {{ appointment.doctor.user.get_full_name }}">
                                                            {% else %}
                                                                <img src="{% static 'images/default-doctor.png' %}" class="rounded-circle" width="40" height="40" alt="Dr. {{ appointment.doctor.user.get_full_name }}">
                                                            {% endif %}
                                                        </div>
                                                        <div>
                                                            <span class="fw-medium">Dr. {{ appointment.doctor.user.get_full_name }}</span>
                                                            <div class="small text-muted">{{ appointment.doctor.specialization.name }}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>{{ appointment.date|format_date }}</td>
                                                <td>{{ appointment.time_slot }}</td>
                                                <td>
                                                    {% if appointment.appointment_type %}
                                                        {{ appointment.appointment_type }}
                                                    {% else %}
                                                        {% if appointment.is_video_consultation %}
                                                            Video Consultation
                                                        {% else %}
                                                            In-Person Visit
                                                        {% endif %}
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="status-badge {{ appointment.status|status_color }}">
                                                        {% if appointment.status == 'pending' %}
                                                            Pending Review
                                                        {% elif appointment.status == 'accepted' %}
                                                            Accepted
                                                        {% elif appointment.status == 'paid' %}
                                                            Paid
                                                        {% elif appointment.status == 'completed' %}
                                                            Completed
                                                        {% elif appointment.status == 'cancelled' %}
                                                            Cancelled
                                                        {% elif appointment.status == 'rejected' %}
                                                            Rejected
                                                        {% endif %}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if appointment.is_paid or appointment.payment_status == 'paid' %}
                                                        <span class="payment-badge paid">
                                                            <i class="fas fa-check-circle"></i> Paid
                                                        </span>
                                                    {% elif appointment.status == 'accepted' %}
                                                        <span class="payment-badge pending">
                                                            <i class="fas fa-clock"></i> Pending
                                                        </span>
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                                <td class="position-relative" style="z-index: 101;">
                                                    {% if appointment.status == 'accepted' and not appointment.is_paid and appointment.payment_status != 'paid' %}
                                                        <button type="button" class="btn btn-success btn-sm payment-btn" data-appointment-id="{{ appointment.id }}">
                                                            <i class="fas fa-credit-card"></i> Pay Now
                                                        </button>
                                                    {% elif appointment.is_paid or appointment.payment_status == 'paid' %}
                                                        <a href="{% url 'appointments:download_invoice' appointment.id %}" class="btn btn-invoice btn-sm">
                                                            <i class="fas fa-file-invoice"></i> Invoice
                                                        </a>
                                                    {% endif %}
                                                    
                                                    {% if not appointment.is_paid and appointment.payment_status != 'paid' and appointment.status not in 'cancelled,completed,rejected' %}
                                                        <button type="button" class="btn btn-primary btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#rescheduleModal{{ appointment.id }}">
                                                            <i class="fas fa-calendar-alt"></i> Reschedule
                                                        </button>
                                                        <button type="button" class="btn btn-danger btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#cancelModal{{ appointment.id }}">
                                                            <i class="fas fa-times"></i> Cancel
                                                        </button>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                
                                {% if all_appointments_count > appointments|length %}
                                <div class="text-center mt-3">
                                    <a href="{% url 'appointments:my_appointments' %}" class="btn btn-outline-primary">
                                        <i class="fas fa-list-ul me-1"></i> View All Appointments ({{ all_appointments_count }})
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <p class="text-muted text-center py-4">No appointments found.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Reschedule Modal -->
        {% for appointment in appointments %}
        <div class="modal fade" id="rescheduleModal{{ appointment.id }}" tabindex="-1" aria-labelledby="rescheduleModalLabel{{ appointment.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="rescheduleModalLabel{{ appointment.id }}">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Reschedule Appointment
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="rescheduleForm{{ appointment.id }}" action="#" method="post">
                        {% csrf_token %}
                        <div class="modal-body">
                            <div class="appointment-details mb-4">
                                <p><strong>Doctor:</strong> {{ appointment.doctor.user.get_full_name }}</p>
                                <p><strong>Current Date:</strong> {{ appointment.date|format_date }}</p>
                                <p><strong>Current Time:</strong> {{ appointment.time_slot }}</p>
                            </div>
                            <div class="mb-3">
                                <label for="new_date{{ appointment.id }}" class="form-label">New Date</label>
                                <input type="date" class="form-control" id="new_date{{ appointment.id }}" name="new_date" required min="{{ today|date:'Y-m-d' }}">
                            </div>
                            <div class="mb-3">
                                <label for="new_time{{ appointment.id }}" class="form-label">New Time</label>
                                <select class="form-control" id="new_time{{ appointment.id }}" name="new_time" required>
                                    <option value="">Select Time</option>
                                    <!-- Use predefined time slots instead of doctors_available_times -->
                                    <option value="09:00-10:00">9:00 AM - 10:00 AM</option>
                                    <option value="10:00-11:00">10:00 AM - 11:00 AM</option>
                                    <option value="11:00-12:00">11:00 AM - 12:00 PM</option>
                                    <option value="12:00-13:00">12:00 PM - 1:00 PM</option>
                                    <option value="13:00-14:00">1:00 PM - 2:00 PM</option>
                                    <option value="14:00-15:00">2:00 PM - 3:00 PM</option>
                                    <option value="15:00-16:00">3:00 PM - 4:00 PM</option>
                                    <option value="16:00-17:00">4:00 PM - 5:00 PM</option>
                                </select>
                                <div class="form-text">Available time slots are shown in 1-hour intervals (HH:MM-HH:MM format)</div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                <span class="btn-text">Confirm Reschedule</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Cancel Modal -->
        <div class="modal fade" id="cancelModal{{ appointment.id }}" tabindex="-1" aria-labelledby="cancelModalLabel{{ appointment.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="cancelModalLabel{{ appointment.id }}">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            Cancel Appointment
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="cancelForm{{ appointment.id }}" action="#" method="post" data-appointment-id="{{ appointment.id }}">
                        {% csrf_token %}
                        <div class="modal-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                Are you sure you want to cancel this appointment?
                            </div>
                            <div class="appointment-details">
                                <p><strong>Doctor:</strong> {{ appointment.doctor.user.get_full_name }}</p>
                                <p><strong>Date:</strong> {{ appointment.date|format_date }}</p>
                                <p><strong>Time:</strong> {{ appointment.time_slot }}</p>
                            </div>
                            <div id="cancelErrorMessages{{ appointment.id }}" class="alert alert-danger mt-3" style="display: none;"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-danger">
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                <span class="btn-text">Cancel Appointment</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Razorpay script -->
        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

        <!-- New Doctor Note Modal -->
        <div class="modal fade" id="newDoctorNoteModal" tabindex="-1" aria-labelledby="newDoctorNoteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="newDoctorNoteModalLabel">
                            <i class="fas fa-comment-medical me-2"></i>
                            Send Message to Doctor
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="doctorNoteForm" action="{% url 'appointments:create_doctor_note' %}" method="post">
                        {% csrf_token %}
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="doctor" class="form-label">Select Doctor</label>
                                <select class="form-select" id="doctor" name="doctor" required>
                                    <option value="">Select a doctor</option>
                                    {% for doctor in doctors %}
                                        <option value="{{ doctor.id }}">Dr. {{ doctor.user.get_full_name }} ({{ doctor.specialization.name }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="message" class="form-label">Your Message</label>
                                <textarea class="form-control" id="message" name="message" rows="5" placeholder="Write your message here..." required></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                <span class="btn-text">Send Message</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% block extra_js %}
        {{ block.super }}
        <script>
            // Payment handling functions
            function initializePayment(appointmentId) {
                console.log('Initializing payment for appointment ID:', appointmentId);
                
                if (!appointmentId || isNaN(appointmentId)) {
                    console.error('Invalid appointment ID:', appointmentId);
                    showAlert('danger', 'Invalid appointment ID. Please try again.');
                    return;
                }

                // Check if Razorpay is available
                if (typeof Razorpay === 'undefined') {
                    console.error('Razorpay is not defined! Script might not be loaded correctly.');
                    showAlert('danger', 'Payment gateway not available. Please reload the page and try again.');
                    return;
                }
                
                // Show loading overlay
                showPaymentOverlay('Initializing payment...');
                
                // Get CSRF token
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                // Create payment order
                fetch(`/appointments/create_payment_order/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ appointment_id: appointmentId })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.message || 'Failed to create payment order');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Hide loading overlay
                    hidePaymentOverlay();
                    
                    if (data.status === 'success') {
                        // Create Razorpay options
                        const options = {
                            key: data.key_id,
                            amount: data.amount,
                            currency: data.currency,
                            name: 'MedApp',
                            description: `Appointment with Dr. ${data.doctor_name}`,
                            order_id: data.order_id,
                            prefill: {
                                name: data.patient_name,
                                email: data.patient_email,
                                contact: data.patient_phone
                            },
                            theme: {
                                color: '#0d6efd'
                            },
                            handler: function(response) {
                                verifyPayment(appointmentId, response);
                            },
                            modal: {
                                ondismiss: function() {
                                    console.log('Payment modal dismissed');
                                }
                            }
                        };
                        
                        // Create and open Razorpay instance
                        try {
                            const rzp = new Razorpay(options);
                            rzp.open();
                        } catch (err) {
                            console.error('Error opening Razorpay:', err);
                            showAlert('danger', 'Error opening payment gateway: ' + err.message);
                        }
                    } else {
                        showAlert('danger', data.message || 'Failed to initialize payment');
                    }
                })
                .catch(error => {
                    hidePaymentOverlay();
                    console.error('Error initializing payment:', error);
                    showAlert('danger', error.message || 'An error occurred. Please try again.');
                });
            }
            
            function verifyPayment(appointmentId, response) {
                // Show processing overlay
                showPaymentOverlay('Processing payment...');
                
                // Get CSRF token
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                // Verify payment with server
                fetch(`/appointments/verify_payment/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appointment_id: appointmentId,
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_signature: response.razorpay_signature
                    })
                })
                .then(response => response.json())
                .then(data => {
                    hidePaymentOverlay();
                    
                    if (data.status === 'success') {
                        // Show success message
                        showPaymentSuccessToast();
                        
                        // Update UI to reflect payment
                        updateAppointmentAfterPayment(appointmentId, data.invoice_url);
                    } else {
                        showAlert('danger', data.message || 'Payment verification failed');
                    }
                })
                .catch(error => {
                    hidePaymentOverlay();
                    console.error('Error verifying payment:', error);
                    showAlert('danger', 'An error occurred while verifying payment');
                });
            }
            
            function updateAppointmentAfterPayment(appointmentId, invoiceUrl) {
                const row = document.querySelector(`.appointment-row[data-appointment-id="${appointmentId}"]`);
                if (row) {
                    // Update status cell
                    const statusCell = row.querySelector('td:nth-child(5)');
                    if (statusCell) {
                        statusCell.innerHTML = '<span class="status-badge success">Paid</span>';
                    }
                    
                    // Update payment cell
                    const paymentCell = row.querySelector('td:nth-child(6)');
                    if (paymentCell) {
                        paymentCell.innerHTML = '<span class="payment-badge paid"><i class="fas fa-check-circle"></i> Paid</span>';
                    }
                    
                    // Update actions cell
                    const actionsCell = row.querySelector('td:nth-child(7)');
                    if (actionsCell) {
                        // Replace pay button with invoice button
                        const payButton = actionsCell.querySelector('.payment-btn');
                        if (payButton) {
                            const invoiceButton = document.createElement('a');
                            invoiceButton.href = invoiceUrl || `{% url 'appointments:download_invoice' 0 %}`.replace('0', appointmentId);
                            invoiceButton.className = 'btn btn-invoice btn-sm';
                            invoiceButton.innerHTML = '<i class="fas fa-file-invoice"></i> Invoice';
                            payButton.parentNode.replaceChild(invoiceButton, payButton);
                        }
                        
                        // Remove reschedule and cancel buttons
                        const rescheduleButton = actionsCell.querySelector('.btn-primary');
                        const cancelButton = actionsCell.querySelector('.btn-danger');
                        if (rescheduleButton) rescheduleButton.remove();
                        if (cancelButton) cancelButton.remove();
                    }
                    
                    // Highlight the row
                    row.classList.add('highlight-new');
                    setTimeout(() => {
                        row.classList.remove('highlight-new');
                    }, 5000);
                }
            }
            
            // Helper functions
            function showAlert(type, message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
                alertDiv.style.zIndex = '1060';
                alertDiv.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                        <div>${message}</div>
                        <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                document.body.appendChild(alertDiv);
                
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }
            
            function showPaymentOverlay(message) {
                const overlay = document.createElement('div');
                overlay.className = 'payment-overlay';
                overlay.id = 'paymentOverlay';
                overlay.innerHTML = `
                    <div class="payment-overlay-content">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5>${message}</h5>
                        <p class="text-muted">Please do not refresh or close this page</p>
                    </div>
                `;
                document.body.appendChild(overlay);
            }
            
            function hidePaymentOverlay() {
                const overlay = document.getElementById('paymentOverlay');
                if (overlay) {
                    overlay.remove();
                }
            }
            
            function showPaymentSuccessToast() {
                const toast = document.createElement('div');
                toast.className = 'payment-toast';
                toast.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <span>Payment successful! Your appointment is confirmed.</span>
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 5000);
            }

            document.addEventListener('DOMContentLoaded', function() {
                // Payment button click handler
                document.querySelectorAll('.payment-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const appointmentId = this.getAttribute('data-appointment-id');
                        initializePayment(appointmentId);
                    });
                });
                
                // Legacy function for backward compatibility
                window.directPaymentHandler = function(appointmentId) {
                    initializePayment(appointmentId);
                };
                
                // Check for payment success in URL
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('payment_success') === 'true') {
                    showPaymentSuccessToast();
                    
                    // Remove query parameters from URL
                    if (window.history && window.history.replaceState) {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }
                
                // Scroll to newly created appointment
                const newAppointmentId = urlParams.get('new_appointment');
                if (newAppointmentId) {
                    const newAppointmentRow = document.querySelector(`.appointment-row[data-appointment-id="${newAppointmentId}"]`);
                    if (newAppointmentRow) {
                        // Scroll to appointment row with smooth animation
                        setTimeout(() => {
                            newAppointmentRow.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center' 
                            });
                            
                            // Make sure appointments tab is active
                            document.querySelector('a[href="#appointments"]').click();
                        }, 500);
                    }
                }
                
                // Handle reschedule form submissions
                document.querySelectorAll('[id^="rescheduleForm"]').forEach(form => {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const appointmentId = this.id.replace('rescheduleForm', '');
                        const formData = new FormData(this);
                        const newDate = formData.get('new_date');
                        const newTime = formData.get('new_time');
                        
                        if (!newDate || !newTime) {
                            showAlert('danger', 'Please select both date and time');
                            return;
                        }
                        
                        // Show loading spinner
                        const submitButton = this.querySelector('button[type="submit"]');
                        const spinner = submitButton.querySelector('.spinner-border');
                        const btnText = submitButton.querySelector('.btn-text');
                        
                        spinner.classList.remove('d-none');
                        submitButton.disabled = true;
                        
                        // Get CSRF token
                        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                        
                        // Send reschedule request
                        fetch(`/api/reschedule/${appointmentId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrftoken,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                new_date: newDate,
                                new_time: newTime
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            // Hide spinner
                            spinner.classList.add('d-none');
                            submitButton.disabled = false;
                            
                            if (data.status === 'success') {
                                // Close modal
                                const modal = bootstrap.Modal.getInstance(document.getElementById(`rescheduleModal${appointmentId}`));
                                modal.hide();
                                
                                // Update the appointment row in the table
                                const row = document.querySelector(`.appointment-row[data-appointment-id="${appointmentId}"]`);
                                if (row) {
                                    // Update date cell (index 1)
                                    const dateCell = row.querySelector('td:nth-child(2)');
                                    if (dateCell) {
                                        dateCell.textContent = data.formatted_date;
                                    }
                                    
                                    // Update time cell (index 2)
                                    const timeCell = row.querySelector('td:nth-child(3)');
                                    if (timeCell) {
                                        timeCell.textContent = data.formatted_time;
                                    }
                                    
                                    // Highlight the updated row
                                    row.classList.add('highlight-new');
                                    setTimeout(() => {
                                        row.classList.remove('highlight-new');
                                    }, 5000);
                                }
                                
                                showAlert('success', 'Appointment rescheduled successfully');
                            } else {
                                showAlert('danger', data.message || 'Failed to reschedule appointment');
                            }
                        })
                        .catch(error => {
                            // Hide spinner
                            spinner.classList.add('d-none');
                            submitButton.disabled = false;
                            
                            console.error('Error rescheduling appointment:', error);
                            showAlert('danger', 'An error occurred. Please try again.');
                        });
                    });
                });
            });
        </script>
        {% endblock %}
    </div>
</div>
{% endblock %}