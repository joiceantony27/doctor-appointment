{% extends 'appointments/base.html' %}
{% load static %}

{% block title %}Payment - {{ appointment.doctor.user.get_full_name }}{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<style>
    .payment-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    }
    
    .payment-details {
        margin-bottom: 2rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 5px;
    }
    
    .payment-form {
        padding: 20px;
        border: 1px solid #e9ecef;
        border-radius: 5px;
    }
    
    #payment-element {
        margin-bottom: 24px;
    }

    #payment-message {
        color: rgb(105, 115, 134);
        font-size: 16px;
        line-height: 20px;
        padding-top: 12px;
        text-align: center;
    }

    #payment-form button {
        background: #5469d4;
        font-family: Arial, sans-serif;
        color: #ffffff;
        border-radius: 4px;
        border: 0;
        padding: 12px 16px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: block;
        transition: all 0.2s ease;
        box-shadow: 0px 4px 5.5px 0px rgba(0, 0, 0, 0.07);
        width: 100%;
    }
    
    #payment-form button:hover {
        filter: contrast(115%);
    }
    
    #payment-form button:disabled {
        opacity: 0.5;
        cursor: default;
    }
    
    .spinner,
    .spinner:before,
    .spinner:after {
        border-radius: 50%;
    }
    
    .spinner {
        color: #ffffff;
        font-size: 22px;
        text-indent: -99999px;
        margin: 0px auto;
        position: relative;
        width: 20px;
        height: 20px;
        box-shadow: inset 0 0 0 2px;
        -webkit-transform: translateZ(0);
        -ms-transform: translateZ(0);
        transform: translateZ(0);
        display: none;
    }
    
    .spinner:before,
    .spinner:after {
        position: absolute;
        content: "";
    }
    
    .spinner:before {
        width: 10.4px;
        height: 20.4px;
        background: #5469d4;
        border-radius: 20.4px 0 0 20.4px;
        top: -0.2px;
        left: -0.2px;
        -webkit-transform-origin: 10.4px 10.2px;
        transform-origin: 10.4px 10.2px;
        -webkit-animation: loading 2s infinite ease 1.5s;
        animation: loading 2s infinite ease 1.5s;
    }
    
    .spinner:after {
        width: 10.4px;
        height: 10.2px;
        background: #5469d4;
        border-radius: 0 10.2px 10.2px 0;
        top: -0.1px;
        left: 10.2px;
        -webkit-transform-origin: 0px 10.2px;
        transform-origin: 0px 10.2px;
        -webkit-animation: loading 2s infinite ease;
        animation: loading 2s infinite ease;
    }
    
    @keyframes loading {
        0% {
            -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container payment-container">
    <h2 class="mb-4">Payment Details</h2>
    
    <div class="payment-details">
        <div class="row">
            <div class="col-md-6">
                        <h5>Appointment Information</h5>
                        <p><strong>Doctor:</strong> {{ appointment.doctor.user.get_full_name }}</p>
                        <p><strong>Date:</strong> {{ appointment.date }}</p>
                        <p><strong>Time:</strong> {{ appointment.time_slot }}</p>
                            </div>
                            <div class="col-md-6">
                <h5>Payment Summary</h5>
                <p><strong>Consultation Fee:</strong> ${{ fee }}</p>
                <p><strong>Tax (10%):</strong> ${{ tax }}</p>
                <p><strong>Total Amount:</strong> ${{ total }}</p>
            </div>
        </div>
    </div>

    <div class="payment-form">
        <form id="payment-form">
            {% csrf_token %}
            <div id="payment-element">
                <!-- Stripe Elements will be inserted here -->
            </div>
            <button id="submit">
                <div class="spinner" id="spinner"></div>
                <span id="button-text">Pay Now</span>
            </button>
            <div id="payment-message" class="hidden"></div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    let stripe = Stripe('{{ stripe_public_key }}');
    let elements;
    let paymentElement;
    
    initialize();
    
    async function initialize() {
        try {
            const response = await fetch("{% url 'appointments:make_payment' appointment.id %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });
            
            const { clientSecret, publicKey } = await response.json();
            
            const appearance = {
                theme: 'stripe',
                variables: {
                    colorPrimary: '#5469d4',
                },
            };
            
            elements = stripe.elements({ appearance, clientSecret });
            paymentElement = elements.create("payment");
            paymentElement.mount("#payment-element");
            
            document.querySelector("#payment-form").addEventListener("submit", handleSubmit);
        } catch (error) {
            console.error("Error:", error);
            showMessage("An error occurred while initializing the payment. Please try again.");
        }
    }
    
    async function handleSubmit(e) {
        e.preventDefault();
        setLoading(true);
        
        try {
            const { error } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    return_url: window.location.origin + "{% url 'appointments:patient_dashboard' %}",
                },
            });
            
            if (error) {
                showMessage(error.message);
            } else {
                // Payment successful, process on server
                const response = await fetch("{% url 'appointments:process_payment' appointment.id %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: JSON.stringify({
                        paymentIntentId: clientSecret.split('_secret_')[0],
                    }),
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    window.location.href = "{% url 'appointments:patient_dashboard' %}";
                } else {
                    showMessage(result.message || "An error occurred. Please try again.");
                }
            }
        } catch (error) {
            console.error("Error:", error);
            showMessage("An error occurred. Please try again.");
        }
        
        setLoading(false);
    }
    
    function showMessage(messageText) {
        const messageContainer = document.querySelector("#payment-message");
        messageContainer.classList.remove("hidden");
        messageContainer.textContent = messageText;
        setTimeout(function () {
            messageContainer.classList.add("hidden");
            messageText.textContent = "";
        }, 4000);
    }
    
    function setLoading(isLoading) {
        if (isLoading) {
            document.querySelector("#submit").disabled = true;
            document.querySelector("#spinner").style.display = "inline";
            document.querySelector("#button-text").style.display = "none";
        } else {
            document.querySelector("#submit").disabled = false;
            document.querySelector("#spinner").style.display = "none";
            document.querySelector("#button-text").style.display = "inline";
        }
    }
</script>
{% endblock %} 